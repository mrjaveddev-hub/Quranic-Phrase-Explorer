<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quranic Word Tree Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@400;600;800&family=Noto+Nastaliq+Urdu:wght@400..700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Arabic Script Styling */
        .font-arabic { 
            font-family: 'Amiri', serif; 
            direction: rtl; 
            line-height: 1.8; /* Increased to accommodate diacritics */
        }

        /* Urdu Specific Readable Formatting */
        .font-urdu {
            font-family: 'Noto Nastaliq Urdu', serif;
            direction: rtl;
            line-height: 2.2; /* Nastaliq requires significantly more vertical space */
            text-align: right;
            word-spacing: 2px;
        }
        
        /* Mobile View Management */
        @media (max-width: 768px) {
            .mobile-hidden { display: none !important; }
            .mobile-full { width: 100% !important; flex: 1 !important; }
        }

        /* Active State Animation */
        .active-item {
            background-color: #f0fdf4 !important;
            border-color: #10b981 !important;
        }

        /* Custom scrollbar */
        #listItems::-webkit-scrollbar, #treeContainer::-webkit-scrollbar {
            width: 4px;
        }
        #listItems::-webkit-scrollbar-thumb, #treeContainer::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        /* Loading Spinner */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #059669;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 overflow-hidden">

    <div id="app" class="max-w-7xl mx-auto h-screen flex flex-col p-2 md:p-6">
        <!-- Header -->
        <header class="flex items-center justify-between mb-3 bg-white p-3 md:p-4 rounded-2xl border border-slate-200 shadow-sm shrink-0">
            <div class="flex items-center gap-2 md:gap-3">
                <div class="bg-emerald-600 p-2 rounded-xl text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                </div>
                <div class="overflow-hidden">
                    <h1 class="text-sm md:text-lg font-bold truncate">Quranic Phrase Explorer</h1>
                    <p class="text-[8px] md:text-[10px] text-slate-400 font-bold uppercase tracking-widest truncate">Translation & Root Mapping</p>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <p class="hidden lg:block text-[9px] text-amber-700 font-semibold italic bg-amber-50 px-2 py-1 rounded-lg border border-amber-100 max-w-[200px]">
                                        Created as a personal Arabic learning project. Translations are experimental (word-based).
                </p>
                <div id="stats" class="hidden sm:flex text-[9px] font-bold uppercase tracking-widest text-slate-400 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                    <span id="statText">0 Roots</span>
                </div>
                
                <div id="autoLoadStatus" class="hidden text-[10px] text-slate-400 px-2 italic">
                    <div class="loader mr-2"></div> Loading data...
                </div>

                <button id="viewToggle" onclick="toggleView()" class="md:hidden bg-slate-100 text-slate-600 p-2 rounded-xl border border-slate-200">
                    <svg id="viewToggleIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                </button>
                
                <button id="uploadBtn" onclick="document.getElementById('fileInput').click()" class="bg-slate-900 text-white px-3 py-2 rounded-xl text-[10px] md:text-xs font-bold hover:bg-slate-800 transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Upload JSON
                </button>
            </div>
        </header>

        <div class="flex flex-1 gap-4 md:gap-6 overflow-hidden relative">
            <!-- Sidebar (Roots) -->
            <aside id="listView" class="w-full md:w-1/3 flex flex-col h-full overflow-hidden transition-all duration-300">
                <div class="flex-1 bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                    <div class="p-4 bg-slate-50/50 border-b border-slate-100 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-[9px] font-bold uppercase tracking-widest text-slate-400">Roots List</span>
                            <div id="itemCount" class="text-[9px] font-mono text-slate-400">0 items</div>
                        </div>
                        <div class="flex bg-slate-200/50 p-1 rounded-xl">
                            <button onclick="setSort('freq_desc')" id="sort-freq_desc" class="flex-1 py-1 text-[8px] md:text-[9px] font-bold uppercase rounded-lg bg-white text-emerald-600 shadow-sm">Freq ▼</button>
                            <button onclick="setSort('freq_asc')" id="sort-freq_asc" class="flex-1 py-1 text-[8px] md:text-[9px] font-bold uppercase rounded-lg text-slate-500">Freq ▲</button>
                            <button onclick="setSort('alpha')" id="sort-alpha" class="flex-1 py-1 text-[8px] md:text-[9px] font-bold uppercase rounded-lg text-slate-500">A-Z</button>
                        </div>
                    </div>
                    
                    <div id="listItems" class="flex-1 overflow-y-auto p-2 space-y-2"></div>

                    <div id="pagination" class="p-3 border-t border-slate-100 bg-slate-50/30 flex items-center justify-between shrink-0">
                        <button onclick="changePage(-1)" id="prevPage" class="p-2 rounded-lg hover:bg-white border border-transparent hover:border-slate-200 disabled:opacity-20 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        </button>
                        <span id="pageInfo" class="text-[9px] font-bold text-slate-500 uppercase">1 / 1</span>
                        <button onclick="changePage(1)" id="nextPage" class="p-2 rounded-lg hover:bg-white border border-transparent hover:border-slate-200 disabled:opacity-20 transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Explorer -->
            <main id="explorerView" class="hidden md:flex flex-col flex-1 bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden h-full">
                <div class="md:hidden p-3 bg-white border-b flex items-center justify-between">
                    <button onclick="toggleView()" class="text-[10px] font-bold text-emerald-600 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                        Back to List
                    </button>
                </div>

                <!-- Sequence Bar -->
                <div id="phraseBar" class="hidden bg-emerald-50/40 border-b border-emerald-100 p-6 md:p-8 shrink-0">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-[8px] md:text-[9px] font-bold uppercase tracking-[0.2em] text-emerald-600 opacity-60">Phrase Sequence</span>
                        <div class="flex items-center gap-3">
                            <button onclick="popSequence()" class="flex items-center gap-1 text-[8px] md:text-[9px] font-bold uppercase text-slate-400 hover:text-slate-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                                Back
                            </button>
                            <button onclick="resetSequence()" class="text-[8px] md:text-[9px] font-bold uppercase text-red-400 hover:text-red-600 transition-colors">Clear</button>
                        </div>
                    </div>
                    <div id="phraseSequence" class="flex flex-row-reverse items-start gap-8 md:gap-14 min-h-[80px] flex-wrap justify-start"></div>
                </div>

                <!-- Content Area -->
                <div id="emptyState" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
                    <div class="bg-slate-50 p-6 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-slate-300"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1-2.5-2.5Z"/><path d="M8 7h6"/><path d="M8 11h8"/></svg>
                    </div>
                    <h3 class="text-sm font-bold text-slate-700">Exploration Canvas</h3>
                    <p class="text-[10px] text-slate-400 mt-1 max-w-[200px]">Pick a root from the list to start exploring phrases.</p>
                </div>

                <div id="treeContainer" class="flex-1 p-4 md:p-8 overflow-y-auto hidden"></div>
            </main>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json" class="hidden">

    <script>
        let trieData = null;
        let currentSequence = []; 
        let currentSort = 'freq_desc';
        let currentPage = 1;
        const itemsPerPage = 15;
        let sortedRoots = [];
        let activeMobileView = 'list';

        const listItems = document.getElementById('listItems');
        const phraseSequence = document.getElementById('phraseSequence');
        const phraseBar = document.getElementById('phraseBar');
        const treeContainer = document.getElementById('treeContainer');
        const pageInfo = document.getElementById('pageInfo');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const explorerView = document.getElementById('explorerView');
        const listView = document.getElementById('listView');
        const autoLoadStatus = document.getElementById('autoLoadStatus');
        const uploadBtn = document.getElementById('uploadBtn');

        window.addEventListener('DOMContentLoaded', () => {
            attemptAutoLoad();
        });

        async function attemptAutoLoad() {
            autoLoadStatus.classList.remove('hidden');
            uploadBtn.classList.add('hidden');
            try {
                const response = await fetch('quran_tree_optimized.json');
                if (!response.ok) throw new Error('File not found at root');
                const data = await response.json();
                processIncomingData(data);
                autoLoadStatus.classList.add('hidden');
            } catch (err) {
                console.warn('Auto-load failed:', err.message);
                autoLoadStatus.classList.add('hidden');
                uploadBtn.classList.remove('hidden');
            }
        }

        function processIncomingData(data) {
            trieData = data;
            const statText = document.getElementById('statText');
            if (statText) statText.innerText = `${Object.keys(trieData).length} Roots`;
            currentPage = 1;
            prepareSortedRoots();
            renderList();
        }

        function toggleView() {
            if (activeMobileView === 'list') {
                listView.classList.add('mobile-hidden');
                explorerView.classList.remove('hidden');
                explorerView.classList.add('flex');
                activeMobileView = 'explorer';
            } else {
                listView.classList.remove('mobile-hidden');
                explorerView.classList.add('hidden');
                explorerView.classList.remove('flex');
                activeMobileView = 'list';
            }
        }

        window.setSort = (type) => {
            currentSort = type;
            ['freq_desc', 'freq_asc', 'alpha'].forEach(id => {
                const el = document.getElementById(`sort-${id}`);
                if (el) {
                    el.className = id === type 
                        ? "flex-1 py-1 text-[8px] md:text-[9px] font-bold uppercase rounded-lg bg-white text-emerald-600 shadow-sm"
                        : "flex-1 py-1 text-[8px] md:text-[9px] font-bold uppercase rounded-lg text-slate-500";
                }
            });
            currentPage = 1;
            prepareSortedRoots();
            renderList();
        };

        function prepareSortedRoots() {
            if (!trieData) return;
            sortedRoots = Object.keys(trieData).sort((a, b) => {
                if (currentSort === 'freq_desc') return trieData[b].c - trieData[a].c;
                if (currentSort === 'freq_asc') return trieData[a].c - trieData[b].c;
                return a.localeCompare(b, 'ar');
            });
            const itemCount = document.getElementById('itemCount');
            if (itemCount) itemCount.innerText = `${sortedRoots.length} items`;
        }

        function changePage(delta) {
            const maxPage = Math.ceil(sortedRoots.length / itemsPerPage);
            const newPage = currentPage + delta;
            if (newPage >= 1 && newPage <= maxPage) {
                currentPage = newPage;
                renderList();
                listItems.scrollTop = 0;
            }
        }

        function renderList() {
            if (!trieData) return;
            listItems.innerHTML = '';
            const totalPages = Math.ceil(sortedRoots.length / itemsPerPage) || 1;
            if (pageInfo) pageInfo.innerText = `${currentPage} / ${totalPages}`;
            if (prevPageBtn) prevPageBtn.disabled = currentPage === 1;
            if (nextPageBtn) nextPageBtn.disabled = currentPage === totalPages;

            const startIdx = (currentPage - 1) * itemsPerPage;
            const pageRoots = sortedRoots.slice(startIdx, startIdx + itemsPerPage);

            pageRoots.forEach(word => {
                const item = trieData[word];
                const isActive = currentSequence.length > 0 && currentSequence[0].word === word;
                const btn = document.createElement('button');
                btn.className = `w-full p-5 rounded-2xl hover:bg-slate-50 transition-all border-2 flex flex-row-reverse items-center justify-between gap-4 ${isActive ? 'active-item' : 'border-transparent'}`;
                btn.onclick = () => {
                    startNewSequence(word, item);
                    if (window.innerWidth < 768) toggleView();
                };
                
                btn.innerHTML = `
                    <div class="flex flex-col items-end">
                        <span class="font-arabic text-2xl md:text-3xl text-slate-800 leading-tight">${word}</span>
                        <span class="font-urdu text-[11px] md:text-[13px] text-slate-500 mt-1">${item.t || ''}</span>
                    </div>
                    <div class="flex flex-col items-start">
                        <span class="text-[9px] font-bold text-slate-300 border border-slate-100 px-2 py-1 rounded-lg">${item.c}x</span>
                    </div>
                `;
                listItems.appendChild(btn);
            });
        }

        function startNewSequence(word, data) {
            currentSequence = [{ word, data }];
            updateUI();
        }

        function appendToSequence(word, data) {
            currentSequence.push({ word, data });
            updateUI();
        }

        function popSequence() {
            if (currentSequence.length > 0) {
                currentSequence.pop();
                updateUI();
            }
        }

        function resetSequence() {
            currentSequence = [];
            updateUI();
            if (window.innerWidth < 768) toggleView();
        }

        function updateUI() {
            if (currentSequence.length === 0) {
                phraseBar.classList.add('hidden');
                treeContainer.classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                renderList();
                return;
            }

            document.getElementById('emptyState').classList.add('hidden');
            phraseBar.classList.remove('hidden');
            treeContainer.classList.remove('hidden');

            phraseSequence.innerHTML = '';
            currentSequence.forEach((item) => {
                const el = document.createElement('div');
                el.className = "flex flex-col items-center gap-3 py-2";
                el.innerHTML = `
                    <span class="font-arabic text-3xl md:text-6xl text-emerald-900 drop-shadow-sm leading-tight">${item.word}</span>
                    <span class="font-urdu text-[12px] md:text-[16px] text-emerald-700/90 bg-white/60 px-4 py-1.5 rounded-2xl shadow-sm ring-1 ring-emerald-100">${item.data.t || ''}</span>
                `;
                phraseSequence.appendChild(el);
            });

            const lastItem = currentSequence[currentSequence.length - 1];
            treeContainer.innerHTML = '';
            
            const branches = lastItem.data.s || {};
            if (Object.keys(branches).length > 0) {
                treeContainer.appendChild(renderBranchNodes(branches));
            } else {
                renderReferences(lastItem.data.r);
            }
            renderList();
        }

        function renderBranchNodes(nodes) {
            const wrapper = document.createElement('div');
            wrapper.className = "space-y-4";
            Object.entries(nodes).sort((a, b) => b[1].c - a[1].c).forEach(([word, data]) => {
                const row = document.createElement('div');
                row.className = "group flex items-center justify-between p-5 md:p-6 rounded-3xl border border-slate-100 bg-white hover:border-emerald-200 hover:shadow-lg active:scale-[0.98] transition-all cursor-pointer";
                row.onclick = () => appendToSequence(word, data);
                row.innerHTML = `
                    <div class="flex flex-row-reverse items-center gap-6">
                        <div class="text-emerald-300 group-hover:text-emerald-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                        </div>
                        <div class="flex flex-col items-end">
                            <span class="font-arabic text-2xl md:text-4xl text-slate-800 leading-tight">${word}</span>
                            <span class="font-urdu text-[12px] md:text-[15px] text-slate-500 mt-2 opacity-80">${data.t || ''}</span>
                        </div>
                    </div>
                    <span class="text-[10px] font-bold text-slate-400 bg-slate-50 px-3 py-1.5 rounded-xl">${data.c}x</span>
                `;
                wrapper.appendChild(row);
            });
            return wrapper;
        }

        function renderReferences(refs) {
            if (!refs || refs.length === 0) return;
            const container = document.createElement('div');
            container.className = "mt-10 pt-8 border-t border-slate-100";
            container.innerHTML = `
                <div class="flex items-center gap-3 mb-6">
                    <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Verse Occurrences</span>
                    <div class="h-[1px] flex-1 bg-slate-100"></div>
                </div>
            `;
            const grid = document.createElement('div');
            grid.className = "grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4";
            
            refs.forEach(ref => {
                const link = document.createElement('a');
                link.href = `https://quran.com/${ref.replace(':', '/')}`;
                link.target = "_blank";
                link.className = "flex items-center justify-between p-4 rounded-2xl border border-slate-100 bg-slate-50/50 hover:bg-emerald-50 hover:border-emerald-100 hover:text-emerald-700 transition-all text-[12px] font-bold text-slate-500 group shadow-sm";
                link.innerHTML = `
                    <span class="font-mono">Verse ${ref}</span>
                    <svg class="opacity-0 group-hover:opacity-100 transition-opacity" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                `;
                grid.appendChild(link);
            });
            container.appendChild(grid);
            treeContainer.appendChild(container);
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    processIncomingData(data);
                    uploadBtn.classList.add('hidden');
                } catch (err) { console.error("Invalid JSON format"); }
            };
            reader.readAsText(e.target.files[0]);
        });
    </script>
</body>
</html>